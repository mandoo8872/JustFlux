# 🔄 JustFlux v2 리팩토링 로그

## 📋 개요

이 문서는 JustFlux v2의 확장 가능한 아키텍처 구축을 위한 리팩토링 과정을 기록합니다.

**목표**: 입력(그림파일 추가, OCR 모드), 편집(레이어 확장, AI 엔진 연동), 출력(이메일 자동 전달, 로컬 출력) 기능을 위한 확장 가능한 구조 구축

---

## 🎯 리팩토링 목표

### **핵심 목표**
1. **확장성**: 새로운 기능 추가 시 기존 코드 수정 최소화
2. **유지보수성**: 파일 크기 감소, 복잡도 감소
3. **테스트 용이성**: 단위 테스트 가능한 구조
4. **성능**: 메모리 효율성, 렌더링 최적화

### **기대 효과**
- **개발 생산성**: 70% 향상
- **버그 수정**: 80% 빠른 디버깅
- **코드 재사용**: 90% 향상
- **파일 크기**: 평균 200줄 이하

---

## 📊 현재 상황 분석

### **문제점**
- **Shell.tsx**: 1,921줄의 거대한 단일 파일
- **복잡한 상태 관리**: 모든 로직이 하나의 컴포넌트에 집중
- **확장성 부족**: 새로운 기능 추가 시 기존 코드 수정 필요
- **테스트 어려움**: 단일 파일로 인한 테스트 복잡성

### **분리해야 할 핵심 요소**
1. **주석 시스템**: 8개 이상의 주석 타입이 하나의 파일에서 처리
2. **상태 관리**: 문서, 주석, 뷰, 히스토리 상태가 하나의 스토어에 집중
3. **내보내기 시스템**: PDF, PNG, JPEG 등 형식별 로직 분산
4. **AI 엔진 연동**: OCR, AI 분석, 자동 제안 등 기능 추가 시 구조적 문제

---

## 🏗️ 새로운 아키텍처

### **디렉토리 구조**
```
src/
├── domains/                    # 도메인별 모듈화
│   ├── annotations/           # 주석 시스템
│   │   ├── services/         # AnnotationService, AnnotationRegistry
│   │   ├── components/       # AnnotationManager, AnnotationRenderer
│   │   ├── types/           # AnnotationTypes
│   │   └── utils/           # 유틸리티
│   ├── layers/              # 레이어 시스템 (준비됨)
│   ├── ai/                  # AI 시스템 (준비됨)
│   ├── input/               # 입력 시스템 (준비됨)
│   └── output/              # 출력 시스템 (준비됨)
├── state/                    # 상태 관리 분리
│   ├── stores/              # AnnotationStore, ViewStore
│   ├── services/            # StateSyncService
│   └── hooks/               # 커스텀 훅들
├── core/                    # 핵심 시스템
│   ├── events/              # EventBus
│   ├── di/                  # DIContainer
│   └── validation/          # 검증 시스템
└── ui/                      # UI 컴포넌트
    ├── layout/              # Shell 분해 예정
    └── features/            # 기능별 컴포넌트
```

---

## ✅ 완료된 작업

### **Phase 1: 확장 가능한 파일 구조 설계 및 생성** ✅

#### **1.1 디렉토리 구조 생성**
- [x] `src/domains/` - 도메인별 모듈화
- [x] `src/state/stores/` - 상태 관리 분리
- [x] `src/core/events/` - 이벤트 시스템
- [x] `src/core/di/` - 의존성 주입

#### **1.2 주석 시스템 모듈화**
- [x] `AnnotationRegistry.ts` - 주석 타입 등록 시스템
- [x] `AnnotationService.ts` - 주석 비즈니스 로직
- [x] `AnnotationManager.tsx` - 주석 관리 컴포넌트
- [x] `AnnotationRenderer.tsx` - 기존 컴포넌트 래핑
- [x] `AnnotationTypes.ts` - 타입 정의

#### **1.3 상태 관리 분리**
- [x] `AnnotationStore.ts` - 주석 관련 상태
- [x] `ViewStore.ts` - 뷰 관련 상태
- [x] 이벤트 시스템 구축

#### **1.4 핵심 시스템 구축**
- [x] `EventBus.ts` - 이벤트 기반 아키텍처
- [x] `Container.ts` - 의존성 주입 컨테이너
- [x] `index.ts` - 통합 진입점

---

## 🔧 현재 진행 중인 작업

### **Phase 2: 타입 오류 수정 및 통합** 🚧

#### **2.1 타입 호환성 문제 해결**
- [ ] 기존 주석 컴포넌트들과의 호환성 수정
- [ ] `BaseAnnotationComponent` 인터페이스 수정
- [ ] `AnnotationRenderer` 타입 오류 해결

#### **2.2 기존 코드와의 통합**
- [ ] Shell.tsx에서 새로운 AnnotationManager 사용
- [ ] 기존 AnnotationLayerV2 대체
- [ ] 빌드 오류 완전 해결

#### **2.3 현재 오류 상황**
```
❌ 타입 오류: 20개
❌ 빌드 실패: TypeScript 컴파일 오류
❌ 호환성 문제: 기존 컴포넌트와 새 시스템 간 불일치
```

---

## 📋 남은 작업 계획

### **Phase 3: 상태 관리 완전 분리** 📅

#### **3.1 DocumentStore 분해**
- [ ] DocumentStore에서 주석 관련 부분 제거
- [ ] 새로운 스토어들과 연동
- [ ] 이벤트 시스템 완성

#### **3.2 Shell.tsx 분해**
- [ ] Header 컴포넌트 분리 (200줄 이하)
- [ ] Sidebar 컴포넌트 분리 (200줄 이하)
- [ ] MainContent 컴포넌트 분리 (200줄 이하)

### **Phase 4: 내보내기 시스템 분리** 📅

#### **4.1 Export 도메인 구현**
- [ ] `BaseExporter.ts` - 기본 내보내기 인터페이스
- [ ] `PDFExporter.ts` - PDF 내보내기
- [ ] `ImageExporter.ts` - 이미지 내보내기
- [ ] `EmailExporter.ts` - 이메일 전달
- [ ] `CloudExporter.ts` - 클라우드 저장

#### **4.2 AI 시스템 기반 구축**
- [ ] `BaseAIEngine.ts` - AI 엔진 기본 인터페이스
- [ ] `OCRService.ts` - OCR 처리
- [ ] `AIService.ts` - AI 분석
- [ ] `SuggestionService.ts` - 자동 제안

### **Phase 5: 레이어 시스템 확장** 📅

#### **5.1 레이어 도메인 구현**
- [ ] `LayerService.ts` - 레이어 관리
- [ ] `BlendModeService.ts` - 블렌드 모드
- [ ] `FilterService.ts` - 필터 처리
- [ ] `LayerManager.tsx` - 레이어 관리자

### **Phase 6: 최종 통합 및 최적화** 📅

#### **6.1 성능 최적화**
- [ ] 메모리 사용량 최적화
- [ ] 렌더링 성능 향상
- [ ] 번들 크기 최적화

#### **6.2 테스트 및 문서화**
- [ ] 단위 테스트 작성
- [ ] 통합 테스트 작성
- [ ] API 문서화
- [ ] 사용자 가이드 작성

---

## 🎯 핵심 설계 원칙

### **1. 단일 책임 원칙 (SRP)**
- 각 모듈은 하나의 책임만 가짐
- 주석 관리, 상태 관리, 내보내기 등 분리

### **2. 의존성 역전 원칙 (DIP)**
- 고수준 모듈이 저수준 모듈에 의존하지 않음
- 인터페이스를 통한 의존성 주입

### **3. 개방-폐쇄 원칙 (OCP)**
- 확장에는 열려있고 수정에는 닫혀있음
- 새로운 주석 타입, 내보내기 형식 쉽게 추가

### **4. 인터페이스 분리 원칙 (ISP)**
- 클라이언트는 사용하지 않는 인터페이스에 의존하지 않음
- 작은 인터페이스들로 분리

---

## 📈 진행률 추적

### **전체 진행률: 25%**

#### **완료된 영역**
- ✅ 파일 구조 설계 (100%)
- ✅ 주석 시스템 기반 구축 (80%)
- ✅ 상태 관리 분리 (60%)
- ✅ 이벤트 시스템 구축 (100%)

#### **진행 중인 영역**
- 🚧 타입 오류 수정 (30%)
- 🚧 기존 코드 통합 (10%)

#### **대기 중인 영역**
- ⏳ Shell.tsx 분해 (0%)
- ⏳ 내보내기 시스템 분리 (0%)
- ⏳ AI 시스템 구축 (0%)
- ⏳ 레이어 시스템 확장 (0%)

---

## 🚨 현재 블로커

### **1. 타입 호환성 문제**
- 기존 주석 컴포넌트들과 새로운 시스템 간 타입 불일치
- `BaseAnnotationComponent` 인터페이스 수정 필요
- 기존 컴포넌트들의 props 구조 변경 필요

### **2. 빌드 오류**
- TypeScript 컴파일 오류 20개
- require() 사용으로 인한 Node.js 타입 오류
- 기존 코드와의 통합 문제

### **3. 기존 코드 의존성**
- Shell.tsx의 거대한 구조로 인한 통합 어려움
- 기존 AnnotationLayerV2와의 호환성 문제

---

## 🎯 다음 단계 우선순위

### **즉시 해결 필요 (High Priority)**
1. **타입 오류 수정** - 빌드 성공을 위한 필수 작업
2. **기존 컴포넌트 호환성** - 기존 기능 유지를 위한 필수 작업
3. **Shell.tsx 통합** - 새로운 시스템 사용을 위한 필수 작업

### **단기 목표 (1-2주)**
1. **Shell.tsx 분해** - 유지보수성 향상을 위한 중요 작업
2. **상태 관리 완전 분리** - 확장성을 위한 중요 작업
3. **내보내기 시스템 분리** - 새로운 기능 추가를 위한 중요 작업

### **중기 목표 (1개월)**
1. **AI 시스템 구축** - OCR, AI 분석 기능 추가
2. **레이어 시스템 확장** - 고급 편집 기능 추가
3. **성능 최적화** - 사용자 경험 향상

---

## 📝 참고 사항

### **코드 스타일 가이드**
- TypeScript strict 모드 사용
- ESLint 규칙 준수
- JSDoc 주석 필수
- 단위 테스트 작성

### **성능 고려사항**
- 메모리 누수 방지
- 렌더링 최적화
- 번들 크기 최적화
- 지연 로딩 적용

### **확장성 고려사항**
- 플러그인 아키텍처
- 이벤트 기반 통신
- 의존성 주입
- 모듈화된 구조

---

## 🔄 업데이트 로그

### **2024-12-19**
- ✅ 파일 구조 설계 및 생성 완료
- ✅ 주석 시스템 모듈화 완료
- ✅ 상태 관리 분리 완료
- ✅ 이벤트 시스템 구축 완료
- 🚧 타입 오류 수정 진행 중 (30% 완료)
- 🚧 기존 코드 통합 진행 중 (10% 완료)

### **현재 블로커 상황**
- ❌ 타입 호환성 문제: 기존 주석 컴포넌트들과 새로운 시스템 간 props 불일치
- ❌ 모듈 import 문제: EventBus 경로 및 타입 import 문제  
- ❌ Shell.tsx 통합 문제: 기존 코드와의 호환성 문제
- ❌ AnnotationService 타입 오류: createAnnotation 반환 타입 불일치

### **다음 우선순위**
1. **타입 호환성 문제 해결** - 기존 컴포넌트 props 구조 분석 및 수정
2. **모듈 import 문제 해결** - 경로 수정 및 타입 import 방식 변경
3. **점진적 통합 전략** - 기존 코드 유지하면서 새 시스템 단계적 도입

---

### **2026-02-01**
- ✅ **어노테이션 시스템 안정화**
  - 빈 페이지에서 어노테이션이 렌더링되지 않는 버그 수정 (`PageViewer.tsx` 가드 로직 개선)
  - 어노테이션 선택 시 크기 조절 핸들이 표시되지 않는 버그 수정 (`AnnotationStore` 상태 동기화)
  - `ShapeAnnotation`의 이벤트 캡처 로직 수정으로 선택 반응성 향상
- ✅ **멀티 포맷 지원 완료**
  - Markdown, Text, Image 파일 로딩 지원 추가
  - 빈 페이지 추가 기능 구현 및 어노테이션 연동 확인

### **현재 상태**
- 어노테이션 시스템이 빈 페이지를 포함한 모든 페이지에서 정상 작동
- 멀티 포맷(PDF, MD, TXT, IMG) 로딩 및 편집 가능

---

**이 문서는 리팩토링 진행 상황을 실시간으로 업데이트하며, 완료될 때까지 참조용으로 사용됩니다.**
